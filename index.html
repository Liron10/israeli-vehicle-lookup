<!doctype html>
<html lang="he">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vehicle OCR Advanced</title>

  <!-- OCR -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;direction:rtl;margin:0;background:#f2f5fb;padding:20px}
    .container{max-width:980px;margin:0 auto;background:#fff;border:1px solid #e6e9f2;border-radius:16px;box-shadow:0 10px 30px rgba(16,24,40,.08);padding:16px}
    h2{margin:0 0 12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{border:0;border-radius:10px;padding:10px 12px;background:#0b57d0;color:#fff;font-weight:800;cursor:pointer}
    .btn.secondary{background:#fff;color:#0b57d0;border:1px solid #0b57d0}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .hint{margin-top:10px;font-size:12px;line-height:1.4;color:#4a5568}
    .status{margin-top:12px;padding:10px 12px;border-radius:10px;font-weight:800;font-size:13px;line-height:1.4;display:none}
    .ok{background:#e8f5e9;color:#1b5e20;border:1px solid #66bb6a}
    .warn{background:#fff3e0;color:#8a4b00;border:1px solid #ffb74d}
    .bad{background:#ffebee;color:#b71c1c;border:1px solid #ef5350}
    .imgwrap{margin-top:12px;background:#fff;border:1px solid #e6e9f2;border-radius:12px;padding:10px;display:none}
    img{max-width:100%;border-radius:10px}
    input{width:100%;padding:12px;border:1px solid #d7dcec;border-radius:10px;font-size:20px;font-weight:900;letter-spacing:2px;direction:ltr;text-align:center}
    .box{margin-top:12px;border:1px solid #e6e9f2;border-radius:14px;background:#fafbff;padding:12px}
    pre{margin:0;white-space:pre-wrap;word-break:break-word;direction:ltr;text-align:left}
    canvas{display:none}
  </style>
</head>

<body>
  <div class="container">
    <h2>OCR לוחית חכם (אוטומטי)</h2>

    <div class="row">
      <button class="btn" id="btnPick">העלה תמונה</button>
      <button class="btn secondary" id="btnClear" disabled>נקה</button>
      <input type="file" id="fileInput" accept="image/*" hidden />
    </div>

    <div class="hint">
      עובד כך: מאתר אזור צהוב (לוחית) → חיתוך + הגדלה → OCR בכמה וריאציות → מנסה מועמדים מול המאגר עד שמוצא.
    </div>

    <div id="status" class="status"></div>

    <div id="imgwrap" class="imgwrap">
      <img id="preview" alt="preview" />
    </div>

    <div class="box">
      <div class="hint"><b>ידני:</b> הזן רק ספרות (7–8)</div>
      <div style="margin-top:10px">
        <input id="plateInput" placeholder="3358931" maxlength="8" inputmode="numeric" />
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="btnSearch">חפש במאגר</button>
      </div>
    </div>

    <div class="box" id="resultBox" style="display:none;background:#e8f5e9;border-color:#c8e6c9">
      <b>תוצאה:</b>
      <div style="margin-top:8px">
        <pre id="result"></pre>
      </div>
    </div>

    <canvas id="work"></canvas>
    <canvas id="crop"></canvas>
  </div>

<script>
  // ===== SETTINGS =====
  const SERVER_URL = 'https://israeli-vehicle-lookup.onrender.com';

  // ===== ELEMENTS =====
  const fileInput  = document.getElementById('fileInput');
  const btnPick    = document.getElementById('btnPick');
  const btnClear   = document.getElementById('btnClear');
  const btnSearch  = document.getElementById('btnSearch');
  const preview    = document.getElementById('preview');
  const imgwrap    = document.getElementById('imgwrap');
  const statusDiv  = document.getElementById('status');
  const plateInput = document.getElementById('plateInput');
  const resultBox  = document.getElementById('resultBox');
  const resultPre  = document.getElementById('result');
  const work       = document.getElementById('work');
  const crop       = document.getElementById('crop');

  // ===== HELPERS =====
  function setStatus(type, msg) {
    statusDiv.className = 'status ' + type;
    statusDiv.innerHTML = msg;
    statusDiv.style.display = 'block';
  }

  function clearStatus() {
    statusDiv.style.display = 'none';
    statusDiv.innerHTML = '';
  }

  function normalizeDigits(s) {
    return String(s || '').replace(/\D/g, '');
  }

  function resetAll() {
    fileInput.value = '';
    preview.src = '';
    imgwrap.style.display = 'none';
    btnClear.disabled = true;
    plateInput.value = '';
    resultBox.style.display = 'none';
    resultPre.textContent = '';
    clearStatus();
  }

  function showResult(obj) {
    resultPre.textContent = JSON.stringify(obj, null, 2);
    resultBox.style.display = 'block';
  }

  // ===== OCR: detect yellow-ish region =====
  function isYellowish(r,g,b) {
    // לוחית צהובה: R,G גבוהים, B נמוך יחסית
    return (r > 140 && g > 120 && b < 150 && (r + g) > 320);
  }

  function findYellowBox(imageData, w, h) {
    const d = imageData.data;

    let minX = w, minY = h, maxX = -1, maxY = -1;
    let hits = 0;

    // דגימה כדי להאיץ
    const step = 2;

    for (let y=0; y<h; y+=step) {
      for (let x=0; x<w; x+=step) {
        const i = (y*w + x) * 4;
        const r = d[i], g = d[i+1], b = d[i+2];
        if (isYellowish(r,g,b)) {
          hits++;
          if (x < minX) minX = x;
          if (y < minY) minY = y;
          if (x > maxX) maxX = x;
          if (y > maxY) maxY = y;
        }
      }
    }

    if (hits < 350 || maxX < 0) return null;

    let bw = maxX - minX;
    let bh = maxY - minY;

    // הרחבה
    const padX = Math.floor(bw * 0.25);
    const padY = Math.floor(bh * 0.55);

    minX = Math.max(0, minX - padX);
    minY = Math.max(0, minY - padY);
    maxX = Math.min(w - 1, maxX + padX);
    maxY = Math.min(h - 1, maxY + padY);

    bw = Math.max(1, maxX - minX);
    bh = Math.max(1, maxY - minY);

    // סינון גודל מינימלי (נמנע מקופסאות רעש)
    if (bw < w * 0.08 || bh < h * 0.04) return null;

    return { x:minX, y:minY, w:bw, h:bh, hits };
  }

  function cropAndUpscale(img, box) {
    const ctx = crop.getContext('2d', { willReadFrequently:true });

    const scale = 3.0;
    crop.width = Math.max(1, Math.floor(box.w * scale));
    crop.height = Math.max(1, Math.floor(box.h * scale));

    ctx.drawImage(
      img,
      box.x, box.y, box.w, box.h,
      0, 0, crop.width, crop.height
    );
  }

  function preprocess(canvas, variant) {
    // variant 0: חזק, variant 1: רך, variant 2: הכי רך
    const ctx = canvas.getContext('2d', { willReadFrequently:true });
    const { width:w, height:h } = canvas;
    const imgData = ctx.getImageData(0,0,w,h);
    const d = imgData.data;

    const contrast = variant === 0 ? 1.65 : (variant === 1 ? 1.35 : 1.15);
    const brightness = variant === 0 ? 12 : (variant === 1 ? 8 : 4);
    const thresh = variant === 0 ? 160 : (variant === 1 ? 175 : 190);

    for (let i=0; i<d.length; i+=4) {
      const r=d[i], g=d[i+1], b=d[i+2];
      let gray = 0.299*r + 0.587*g + 0.114*b;
      gray = (gray - 128) * contrast + 128 + brightness;
      gray = Math.max(0, Math.min(255, gray));
      const v = gray >= thresh ? 255 : 0;
      d[i] = d[i+1] = d[i+2] = v;
    }

    ctx.putImageData(imgData,0,0);
  }

  async function ocrDigits(canvas) {
    const res = await Tesseract.recognize(canvas, 'eng', {
      tessedit_char_whitelist: '0123456789',
      preserve_interword_spaces: '1',
      tessedit_pageseg_mode: '7'
    });
    return normalizeDigits(res?.data?.text || '');
  }

  function uniqueKeep(arr) {
    const seen = new Set();
    const out = [];
    for (const x of arr) {
      if (!seen.has(x)) { seen.add(x); out.push(x); }
    }
    return out;
  }

  function buildCandidatesFromDigits(digits) {
    const out = [];
    // חלונות 8 ואז 7
    for (let len=8; len>=7; len--) {
      for (let i=0; i+len<=digits.length; i++) {
        out.push(digits.slice(i, i+len));
      }
    }
    // אם יש 8 ספרות - נסה למחוק ספרה אחת כדי להגיע ל-7 (OCR מוסיף לפעמים ספרה)
    for (const x of [...out]) {
      if (x.length === 8) {
        for (let i=0; i<8; i++) out.push(x.slice(0,i) + x.slice(i+1));
      }
    }
    return uniqueKeep(out.filter(x => x.length===7 || x.length===8)).slice(0, 30);
  }

  async function detectAndOcr(img) {
    setStatus('warn', 'מאתר לוחית בתמונה...');

    // מציירים תמונה מוקטנת לסריקה מהירה
    const ctx = work.getContext('2d', { willReadFrequently:true });
    const srcW = img.naturalWidth || img.width;
    const srcH = img.naturalHeight || img.height;

    const scanW = 900;
    const scanH = Math.max(1, Math.floor((srcH / srcW) * scanW));
    work.width = scanW;
    work.height = scanH;
    ctx.drawImage(img, 0, 0, scanW, scanH);

    const imgData = ctx.getImageData(0,0,scanW,scanH);
    let box = findYellowBox(imgData, scanW, scanH);

    if (!box) {
      setStatus('bad', 'לא הצלחתי לאתר אזור צהוב (לוחית). נסה תמונה אחרת או הקלד ידנית.');
      return;
    }

    // ממירים קואורדינטות למקור
    const scaleX = srcW / scanW;
    const scaleY = srcH / scanH;

    const srcBox = {
      x: Math.floor(box.x * scaleX),
      y: Math.floor(box.y * scaleY),
      w: Math.floor(box.w * scaleX),
      h: Math.floor(box.h * scaleY)
    };

    // clamp
    srcBox.x = Math.max(0, Math.min(srcW-1, srcBox.x));
    srcBox.y = Math.max(0, Math.min(srcH-1, srcBox.y));
    srcBox.w = Math.max(1, Math.min(srcW-srcBox.x, srcBox.w));
    srcBox.h = Math.max(1, Math.min(srcH-srcBox.y, srcBox.h));

    cropAndUpscale(img, srcBox);

    setStatus('warn', 'מריץ OCR על הלוחית...');

    let digitsConcat = '';
    const tries = 3;

    for (let v=0; v<tries; v++) {
      // משכפלים את crop לקנבס זמני כדי שכל וריאציה לא תהרוס את המקור
      const tmp = document.createElement('canvas');
      tmp.width = crop.width;
      tmp.height = crop.height;
      tmp.getContext('2d').drawImage(crop, 0, 0);

      preprocess(tmp, v);
      const digits = await ocrDigits(tmp);
      if (digits) digitsConcat += digits;
    }

    const candidates = buildCandidatesFromDigits(digitsConcat);

    if (!candidates.length) {
      setStatus('bad', 'OCR לא הצליח להוציא מספר. נסה תמונה אחרת או הקלד ידנית.');
      return;
    }

    setStatus('ok', `זוהו מועמדים. מתחיל לבדוק מול המאגר...<br>${candidates.slice(0,10).join(', ')}`);

    // מנסים אוטומטית מול השרת עד 12 ניסיונות
    const toTry = candidates.slice(0, 12);
    for (let i=0; i<toTry.length; i++) {
      const p = toTry[i];
      plateInput.value = p;
      setStatus('warn', `בודק במאגר: ${p} (${i+1}/${toTry.length})`);
      const found = await searchVehicle(p, true);
      if (found) return;
    }

    setStatus('bad', 'לא נמצאה התאמה במאגר. נסה להזין ידנית.');
  }

  // ===== BACKEND SEARCH =====
  async function searchVehicle(plateMaybe, silent=false) {
    const plate = normalizeDigits(plateMaybe || plateInput.value);

    if (!plate || plate.length < 7 || plate.length > 8) {
      if (!silent) setStatus('bad', 'מספר חייב להיות 7–8 ספרות');
      return false;
    }

    try {
      const r = await fetch(`${SERVER_URL}/api/vehicle/${plate}`);
      const j = await r.json();

      if (j.success && j.data) {
        showResult(j.data);
        setStatus('ok', `נמצא במאגר: ${plate}`);
        return true;
      }

      if (!silent) setStatus('bad', `לא נמצא במאגר: ${plate}`);
      return false;
    } catch (e) {
      console.error(e);
      if (!silent) setStatus('bad', 'שגיאת חיבור לשרת. בדוק SERVER_URL.');
      return false;
    }
  }

  // ===== EVENTS =====
  btnPick.addEventListener('click', () => fileInput.click());

  btnClear.addEventListener('click', () => resetAll());

  btnSearch.addEventListener('click', async () => {
    await searchVehicle();
  });

  plateInput.addEventListener('input', (e) => {
    e.target.value = normalizeDigits(e.target.value).slice(0,8);
  });

  plateInput.addEventListener('keypress', async (e) => {
    if (e.key === 'Enter') await searchVehicle();
  });

  fileInput.addEventListener('change', async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;

    resultBox.style.display = 'none';
    resultPre.textContent = '';

    setStatus('warn', 'טוען תמונה...');
    const url = URL.createObjectURL(file);
    preview.src = url;
    imgwrap.style.display = 'block';
    btnClear.disabled = false;

    await new Promise(res => { preview.onload = () => res(); });

    try {
      await detectAndOcr(preview);
    } catch (err) {
      console.error(err);
      setStatus('bad', 'קרתה שגיאה בעיבוד התמונה. נסה שוב.');
    }
  });

  // init
  resetAll();
</script>
</body>
</html>
