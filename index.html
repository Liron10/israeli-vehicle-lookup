<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vehicle OCR Advanced</title>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<style>
body{
  font-family:Arial;
  direction:rtl;
  background:#f2f4f8;
  margin:0;
  padding:20px;
}
.container{
  max-width:900px;
  margin:auto;
  background:white;
  padding:20px;
  border-radius:16px;
  box-shadow:0 10px 30px rgba(0,0,0,0.1);
}
button{
  padding:10px 14px;
  border-radius:8px;
  border:none;
  background:#0066cc;
  color:white;
  font-weight:bold;
  cursor:pointer;
}
button.secondary{
  background:white;
  color:#0066cc;
  border:1px solid #0066cc;
}
input{
  width:100%;
  padding:12px;
  margin-top:10px;
  font-size:20px;
  text-align:center;
  letter-spacing:3px;
}
.status{
  margin-top:10px;
  padding:10px;
  border-radius:8px;
  display:none;
  font-weight:bold;
}
.ok{background:#e8f5e9;color:#1b5e20}
.warn{background:#fff3e0;color:#e65100}
.bad{background:#ffebee;color:#c62828}
img{
  max-width:100%;
  margin-top:15px;
  border-radius:12px;
}
canvas{display:none}
.result{
  margin-top:15px;
  background:#e8f5e9;
  padding:10px;
  border-radius:8px;
}
</style>
</head>
<body>

<div class="container">

<h2>OCR לוחית חכם</h2>

<button onclick="fileInput.click()">העלה תמונה</button>
<button class="secondary" onclick="resetAll()">נקה</button>
<input type="file" id="fileInput" accept="image/*" hidden>

<img id="preview">

<div class="status" id="status"></div>

<input id="plateInput" placeholder="3358931">

<button onclick="searchVehicle()">חפש במאגר</button>

<div id="result" class="result" style="display:none"></div>

<canvas id="work"></canvas>
<canvas id="crop"></canvas>

</div>

<script>

const SERVER_URL = 'https://israeli-vehicle-lookup.onrender.com';

const preview = document.getElementById("preview");
const statusDiv = document.getElementById("status");
const plateInput = document.getElementById("plateInput");

function setStatus(type,msg){
  statusDiv.className="status "+type;
  statusDiv.innerHTML=msg;
  statusDiv.style.display="block";
}

function resetAll(){
  preview.src="";
  statusDiv.style.display="none";
  plateInput.value="";
  document.getElementById("result").style.display="none";
}

fileInput.addEventListener("change", async e=>{
  const file = e.target.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = async ev=>{
    preview.src = ev.target.result;
    await new Promise(r=>preview.onload=r);
    await detectAndOCR(preview);
  };
  reader.readAsDataURL(file);
});

function normalize(s){
  return String(s||"").replace(/\D/g,"");
}

function buildCandidates(d){
  const arr=[];
  for(let len=8;len>=7;len--){
    for(let i=0;i+len<=d.length;i++){
      arr.push(d.slice(i,i+len));
    }
  }
  return [...new Set(arr)];
}

async function detectAndOCR(img){

  setStatus("warn","מאתר אזור לוחית...");

  const work=document.getElementById("work");
  const ctx=work.getContext("2d",{willReadFrequently:true});
  work.width=img.naturalWidth;
  work.height=img.naturalHeight;
  ctx.drawImage(img,0,0);

  const imgData=ctx.getImageData(0,0,work.width,work.height);
  const data=imgData.data;

  let minX=work.width,minY=work.height,maxX=0,maxY=0,hit=0;

  for(let y=0;y<work.height;y++){
    for(let x=0;x<work.width;x++){
      const i=(y*work.width+x)*4;
      const r=data[i],g=data[i+1],b=data[i+2];
      if(r>150 && g>120 && b<120 && r+g>320){
        hit++;
        if(x<minX)minX=x;
        if(y<minY)minY=y;
        if(x>maxX)maxX=x;
        if(y>maxY)maxY=y;
      }
    }
  }

  if(hit<500){
    setStatus("bad","לא זוהתה לוחית.");
    return;
  }

  const padX=(maxX-minX)*0.2;
  const padY=(maxY-minY)*0.3;

  minX=Math.max(0,minX-padX);
  minY=Math.max(0,minY-padY);
  maxX=Math.min(work.width,maxX+padX);
  maxY=Math.min(work.height,maxY+padY);

  const cropCanvas=document.getElementById("crop");
  const cctx=cropCanvas.getContext("2d");
  cropCanvas.width=(maxX-minX)*3;
  cropCanvas.height=(maxY-minY)*3;

  cctx.drawImage(img,minX,minY,maxX-minX,maxY-minY,0,0,cropCanvas.width,cropCanvas.height);

  setStatus("warn","מריץ OCR...");

  let allDigits="";

  for(let i=0;i<3;i++){
    const tmp=document.createElement("canvas");
    tmp.width=cropCanvas.width;
    tmp.height=cropCanvas.height;
    const tctx=tmp.getContext("2d");
    tctx.drawImage(cropCanvas,0,0);

    const imgD=tctx.getImageData(0,0,tmp.width,tmp.height);
    const d=imgD.data;

    for(let j=0;j<d.length;j+=4){
      const gray=0.299*d[j]+0.587*d[j+1]+0.114*d[j+2];
      const val=gray>150?255:0;
      d[j]=d[j+1]=d[j+2]=val;
    }

    tctx.putImageData(imgD,0,0);

    const res=await Tesseract.recognize(tmp,'eng',{
      tessedit_char_whitelist:'0123456789',
      tessedit_pageseg_mode:'7'
    });

    allDigits+=normalize(res.data.text);
  }

  const candidates=buildCandidates(allDigits);

  if(!candidates.length){
    setStatus("bad","OCR לא הצליח לזהות מספר.");
    return;
  }

  setStatus("ok","מועמדים: "+candidates.join(", "));

  for(const c of candidates){
    const found=await searchVehicle(c,true);
    if(found) return;
  }

  setStatus("bad","לא נמצאה התאמה במאגר.");
}

async function searchVehicle(plate, silent=false){

  const p=normalize(plate||plateInput.value);
  if(!p) return false;

  try{
    const r=await fetch(`${SERVER_URL}/api/vehicle/${p}`);
    const j=await r.json();

    if(j.success){
      document.getElementById("result").innerHTML=
      "<b>נמצא רכב:</b><br>"+JSON.stringify(j.data,null,2);
      document.getElementById("result").style.display="block";
      setStatus("ok","נמצא במאגר: "+p);
      plateInput.value=p;
      return true;
    }
  }catch(e){
    setStatus("bad","שגיאת שרת.");
  }

  return false;
}

</script>
</body>
</html>
